# Author: Rafael J. Vicente <rafaelj.vicente@upm.es>
# Copyright (c) 2025 The QuantumMadrid-UPM-Hackathon-Qiskit-Fall-Fest-2025-QKD project authors. All rights reserved.
name: Code Quality & Security

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  quality-checks:
    name: Static Analysis & Security
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [ "3.9" ]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e . ruff bandit pip-audit mypy radon vulture

      - name: Run Ruff (linting & formatting)
        run: ruff check src tests

      - name: Run Bandit (security scan)
        run: bandit -c pyproject.toml -r src || true

      - name: Run pip-audit (dependency vulnerabilities)
        run: pip-audit || true

      - name: Run Mypy (type checking)
        run: mypy src tests
        env:
          MYPYPATH: src

      - name: Run Radon (complexity check)
        run: |
          echo "=== Cyclomatic Complexity (C > 10 shows warnings) ==="
          radon cc src -nc
          echo "=== Maintainability Index ==="
          radon mi src -nc

      - name: Run Vulture (dead code detection)
        run: vulture src || true

  tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: quality-checks
    strategy:
      matrix:
        python-version: [ "3.9" ]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies for tests
        run: |
          python -m pip install --upgrade pip
          pip install -e . coverage httpx

      - name: Run unit tests with coverage
        run: |
          coverage run -m unittest discover -s tests -p "*.py"
          coverage report -m